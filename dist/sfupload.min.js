/*! Simple File Upload JS API - v0.1.0 - 2013-02-24
* https://github.com/jfroffice/sfupload
* Copyright (c) 2013 John Fischer; Licensed MIT */
(function(e,t,n){function a(e){var t="B";return e>1024&&(e>>=10,t="KB"),e>1024&&(e>>=10,t="MB"),e.toFixed(1).toString().replace(".0","")+" "+t}function f(e){var t=e.target.baseURI,n=t.indexOf("#",0);return n!==-1&&(t=t.slice(0,n)),t}function l(e){if(e.lengthComputable){if(!e.target.file)return;var t=e.target.file,n=new Date,r=(e.loaded-e.target.loaded)/((n-e.target.time)*1.024),i=Math.floor((r+e.target.speed)/2),o=(t.size-e.target.loaded)/1024,u=(o/i+.7*e.target.timeRest)/1.7,f,l=e.target.cur+"/"+e.target.max;e.target.max===1&&(l=""),u<60?f=u.toFixed(0)+" s":f=(u/60).toFixed(0)+" min",i<1024?i+=" KB/s":i=(i/1024).toFixed(1).toString().replace(".0","")+" MB/s",e.target.timeRest=u,e.target.time=n,e.target.loaded=e.loaded,e.target.speed=r,t.type=t.type.replace("/","_"),s({file:t,speed:i,progress:Math.floor(e.loaded/e.total*1e3)/10,timeRest:f,size:a(t.size),info:l})}}function c(t,n){function s(t,n,a){if(a===n.length){i&&i();return}var f=n[a],c=new e.FormData;c.append("file",f),u&&u.abort(),u=new e.XMLHttpRequest,u.upload.file=f,u.upload.time=new Date,u.upload.loaded=u.upload.speed=u.upload.timeRest=0,u.upload.cur=a+1,u.upload.max=n.length,u.upload.addEventListener?u.upload.addEventListener("progress",l,!1):u.upload.attachEvent&&u.upload.attachEvent("progress",l),u.open("POST",t),u.send(c),r&&r(),u.onreadystatechange=function(){if(u.readyState===4&&u.status===200){if(u.responseText!==""){var e=JSON.parse(u.responseText);e.name=f.name,e.type=f.type,e.size=f.size,o(e)}s(t,n,a+1)}}}s(t,n,0)}var r,i,s,o,u;t.fn.sfupload=function(n){var u=this;if(e.File&&e.FileReader&&e.FileList&&e.Blob){u.options={url:"upload",dragndrop:!0,onstart:null,onfinish:null,onprogress:function(){throw new Error("You should defined onprogress: function(data) { file, meanSpeed, progress, size, timeRest }")},onsuccess:function(){throw new Error("You should defined onsuccess: function(file) { name, type, size, data }")}};for(var a in n)u.options[a]=n[a];t(this).on("change",function(e){c(u.options.url,e.target.files)});if(u.options.dragndrop){var l=function(e){e.stopPropagation(),e.preventDefault()},h=function(e){l(e),c(f(e)+u.options.url,e.dataTransfer.files)};e.document.addEventListener("dragenter",l,!1),e.document.addEventListener("dragover",l,!1),e.document.addEventListener("drop",h,!1)}r=u.options.onstart,i=u.options.onfinish,s=u.options.onprogress,o=u.options.onsuccess}}})(this,jQuery);